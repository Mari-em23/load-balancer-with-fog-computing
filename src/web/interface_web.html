<!DOCTYPE html>
<html lang="fr">
  <head>
    <meta charset="UTF-8" />
    <title>Fog Load Balancer</title>
    <style>
      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: #f0f2f5;
        margin: 0;
        padding: 20px;
        color: #333;
      }
      h2 {
        text-align: center;
        color: #4335af;
      }
      .upload-section {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin-bottom: 20px;
      }
      input[type="file"],
      select {
        padding: 8px;
        border-radius: 8px;
        border: 1px solid #ccc;
      }
      button {
        background: linear-gradient(135deg, #4335af, #6c5dd3);
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 10px;
        cursor: pointer;
        font-weight: bold;
        transition: all 0.3s ease;
      }
      table {
        width: 85%;
        margin: auto;
        border-collapse: collapse;
        background: white;
        border-radius: 10px;
        overflow: hidden;
      }
      th,
      td {
        padding: 12px;
        text-align: center;
        border-bottom: 1px solid #ddd;
      }
      th {
        background: #4335af;
        color: white;
      }
      .bar {
        height: 20px;
        border-radius: 10px;
        text-align: right;
        padding-right: 5px;
        color: white;
        font-weight: bold;
      }
      #results-message {
        text-align: center;
        margin-bottom: 10px;
        font-weight: bold;
      }
    </style>
  </head>

  <body>
    <h2>Chiffrement distribué via Fog Nodes</h2>

    <div class="upload-section">
      <input type="file" id="fileInput" />
      <select id="lbType">
        <option value="random">Random</option>
        <option value="hybrid">Hybrid</option>
        <option value="algo">Algo</option>
      </select>
      <button onclick="uploadFile()">Chiffrer</button>
      <button onclick="getMetrics()">Voir Metrics</button>
      <button onclick="downloadEncrypted()">Télécharger fichier chiffré</button>
    </div>

    <div id="results-message"></div>

    <h3>Metrics des nœuds</h3>
    <table>
      <thead>
        <tr>
          <th>Nœud</th>
          <th>CPU %</th>
          <th>RAM %</th>
          <th>Tasks en cours</th>
        </tr>
      </thead>
      <tbody id="metrics"></tbody>
    </table>
    <div id="metrics-summary"></div>

    <h3>Résultats des chunks</h3>
    <table>
      <thead>
        <tr>
          <th>Chunk</th>
          <th>Nœud utilisé</th>
          <th>Temps Fog (s)</th>
          <th>Temps total côté LB (s)</th>
        </tr>
      </thead>
      <tbody id="results"></tbody>
    </table>
    <div id="results-summary"></div>

    <script>
      async function uploadFile() {
        const file = document.getElementById("fileInput").files[0];
        if (!file) {
          alert("Veuillez choisir un fichier.");
          return;
        }

        const lbType = document.getElementById("lbType").value;
        const formData = new FormData();
        formData.append("file", file);
        formData.append("lb_type", lbType);

        document.getElementById("results-message").innerText =
          "Chargement et chiffrement en cours...";

        try {
          const res = await fetch("http://127.0.0.1:5005/send_file", {
            method: "POST",
            body: formData,
          });

          const data = await res.json();
          console.log("Réponse du serveur :", data);

          // Vérification essentielle
          if (!data || !data.results) {
            document.getElementById("results-message").innerText =
              "Réponse invalide : data.results est manquant.";
            console.error("Réponse reçue :", data);
            return;
          }

          const tbody = document.getElementById("results");
          tbody.innerHTML = "";

          data.results.forEach((r) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
            <td>${r.chunk}</td>
            <td>${r.node_used}</td>
            <td>${r.processing_time.toFixed(4)}</td>
            <td>${r.total_time.toFixed(4)}</td>
        `;
            tbody.appendChild(tr);
          });

          document.getElementById("results-message").innerText =
            data.results.length + " chunks traités";

          document.getElementById("results-summary").innerHTML = `
        Throughput: ${data.throughput?.toFixed(2) || "N/A"} tâches/s <br>
        Taux d'erreur: ${data.error_rate?.toFixed(2) || "N/A"}%
      `;
        } catch (err) {
          document.getElementById("results-message").innerText =
            "Erreur : " + err;
        }
      }
      async function downloadEncrypted() {
        const file = document.getElementById("fileInput").files[0];
        if (!file) {
          alert("Veuillez d'abord envoyer un fichier.");
          return;
        }

        const filename = file.name;

        try {
          const res = await fetch(
            `http://127.0.0.1:5005/download_result/${filename}`
          );
          if (!res.ok) {
            alert("Fichier non prêt ou introuvable.");
            return;
          }

          const blob = await res.blob();

          // Créer un lien temporaire pour télécharger
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename + ".encrypted";
          document.body.appendChild(a);
          a.click();

          // Nettoyage
          a.remove();
          window.URL.revokeObjectURL(url);
        } catch (err) {
          alert("Erreur de téléchargement : " + err);
        }
      }
      async function downloadEncrypted() {
        const file = document.getElementById("fileInput").files[0];
        if (!file) {
          alert("Veuillez d'abord envoyer un fichier.");
          return;
        }

        const filename = file.name;

        try {
          const res = await fetch(
            `http://127.0.0.1:5005/download_result/${filename}`
          );
          if (!res.ok) {
            alert("Fichier non prêt ou introuvable.");
            return;
          }

          const blob = await res.blob();

          // Créer un lien temporaire pour télécharger
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement("a");
          a.href = url;
          a.download = filename + ".encrypted";
          document.body.appendChild(a);
          a.click();

          // Nettoyage
          a.remove();
          window.URL.revokeObjectURL(url);
        } catch (err) {
          alert("Erreur de téléchargement : " + err);
        }
      }
    </script>
  </body>
</html>
